<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emotion Voice Recorder</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-lg">

    <h2 class="text-3xl font-bold text-center mb-6 text-indigo-600">
        üé§ Emotion Voice Recorder
    </h2>

    <p class="text-sm text-gray-500 mb-4">
        Rekaman suara dan metadata (termasuk IP publik) akan dikirim otomatis ke server penelitian.
    </p>

    <!-- PARTICIPANT ID -->
    <label class="font-semibold text-gray-700">Participant ID:</label>
    <input id="participantID" type="text"
           class="w-full p-3 rounded-lg border border-gray-300 mt-1 mb-4"
           placeholder="Enter your participant ID">

    <!-- AGE -->
    <label class="font-semibold text-gray-700">Age:</label>
    <input id="age" type="number" min="1"
           class="w-full p-3 rounded-lg border border-gray-300 mt-1 mb-4"
           placeholder="example: 25">

    <!-- GENDER -->
    <label class="font-semibold text-gray-700">Gender:</label>
    <select id="gender"
            class="w-full p-3 rounded-lg border border-gray-300 mt-1 mb-4">
        <option value="">-- Select Gender --</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
    </select>

    <!-- COUNTRY -->
    <label class="font-semibold text-gray-700">Country:</label>
    <select id="country"
            class="w-full p-3 rounded-lg border border-gray-300 mt-1 mb-4">
        <option value="">-- Select Country --</option>
        <option value="Japan">Japan</option>
        <option value="Indonesia">Indonesia</option>
        <option value="Other">Other</option>
    </select>

    <!-- SENTENCE -->
    <label class="font-semibold text-gray-700">Sentence to Speak:</label>
    <select id="sentence"
            class="w-full p-3 rounded-lg border border-gray-300 mt-1 mb-4">
        <option value="">-- Select Sentence --</option>

        <!-- INDONESIAN -->
        <option value="Hari ini hari sabtu.">1. Hari ini hari sabtu.</option>
        <option value="Saya sedang berbelanja.">2. Saya sedang berbelanja.</option>
        <option value="Saya berada di perpustakaan.">3. Saya berada di perpustakaan.</option>
        <option value="Di luar sedang turun hujan.">4. Di luar sedang turun hujan.</option>
        <option value="Saya sedang duduk di dalam ruangan.">5. Saya sedang duduk di dalam ruangan.</option>

        <!-- JAPANESE -->
        <option value="‰ªäÊó•„ÅØÂúüÊõúÊó•„Åß„Åô„ÄÇ">1. ‰ªäÊó•„ÅØÂúüÊõúÊó•„Åß„Åô„ÄÇ</option>
        <option value="ÁßÅ„ÅØË≤∑„ÅÑÁâ©„Çí„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ">2. ÁßÅ„ÅØË≤∑„ÅÑÁâ©„Çí„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</option>
        <option value="ÁßÅ„ÅØÂõ≥Êõ∏È§®„Å´„ÅÑ„Åæ„Åô„ÄÇ">3. ÁßÅ„ÅØÂõ≥Êõ∏È§®„Å´„ÅÑ„Åæ„Åô„ÄÇ</option>
        <option value="Â§ñ„ÅØÈõ®„ÅåÈôç„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ">4. Â§ñ„ÅØÈõ®„ÅåÈôç„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ</option>
        <option value="ÁßÅ„ÅØÈÉ®Â±ã„Å´Â∫ß„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ">5. ÁßÅ„ÅØÈÉ®Â±ã„Å´Â∫ß„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇ</option>
    </select>

    <!-- EMOTION -->
    <label class="font-semibold text-gray-700">Select Emotion:</label>
    <select id="emotion"
            class="w-full p-3 rounded-lg border mt-1 mb-6 border-gray-300">
        <option value="">-- Select Emotion --</option>
        <option value="happy">Happy</option>
        <option value="angry">Angry</option>
        <option value="sad">Sad</option>
        <option value="relaxed">Relaxed</option>
    </select>

    <!-- CONSENT CHECKBOX + LINK -->
    <div class="mb-4">
        <label class="inline-flex items-start">
            <input id="consentCheck" type="checkbox" class="mt-1 mr-2">
            <span class="text-gray-700 text-sm">
                I agree to participate in this research.
                <a id="openModalLink" class="text-indigo-600 underline cursor-pointer ml-1">
                    Read full agreement
                </a>
            </span>
        </label>
    </div>


    <!-- BUTTONS -->
    <div class="flex justify-center space-x-6 mb-6">
        <button id="startBtn"
                class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-full text-xl shadow-md transition">
            üî¥ Record
        </button>

        <button id="stopBtn"
                class="bg-gray-400 text-white px-6 py-3 rounded-full text-xl shadow-md cursor-not-allowed"
                disabled>
            ‚èπ Stop
        </button>
    </div>

    <!-- AUDIO PREVIEW -->
    <audio id="audio" controls class="w-full mb-4 hidden"></audio>

    <!-- STATUS -->
    <div id="status" class="text-sm text-gray-600 mt-2"></div>

</div>

<script>

/* ============================================
   CONSENT CHECKBOX CONTROL
============================================ */

const startBtn = document.getElementById("startBtn");
startBtn.disabled = true;  // Disable record by default

document.getElementById("consentCheck").onchange = (e) => {
    if (e.target.checked) {
        startBtn.disabled = false;
        startBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
        startBtn.classList.add("bg-red-500", "hover:bg-red-600");
    } else {
        startBtn.disabled = true;
        startBtn.classList.remove("bg-red-500", "hover:bg-red-600");
        startBtn.classList.add("bg-gray-400", "cursor-not-allowed");
    }
};

/* ============================================
   AGREEMENT MODAL CONTROL
============================================ */

// Open modal
document.getElementById("openModalLink").onclick = () => {
    document.getElementById("agreementModal").classList.remove("hidden");
};

// Close modal
document.getElementById("closeModalBtn").onclick = () => {
    document.getElementById("agreementModal").classList.add("hidden");
};

// Optional: click outside modal to close
document.getElementById("agreementModal").onclick = (e) => {
    if (e.target === document.getElementById("agreementModal")) {
        document.getElementById("agreementModal").classList.add("hidden");
    }
};


/* ============================================
   GLOBAL VARIABLES
============================================ */
let mediaRecorder;
let audioChunks = [];
let clientIP = "unknown";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzqixNWScqH_crCmF9uFDb7wcZLv3Xqbhw0bCmoP6D1fZy8ZpcO5JSJKmSbDszyykM/exec"; // <-- GANTI

/* ============================================
   AMBIL IP ADDRESS (PUBLIC)
============================================ */
fetch("https://api.ipify.org?format=json")
  .then(res => res.json())
  .then(data => {
      clientIP = data.ip || "unknown";
  })
  .catch(err => {
      console.error("IP fetch error:", err);
      clientIP = "unknown";
  });

/* ============================================
   HELPER: BLOB ‚Üí BASE64
============================================ */
function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
            const base64Data = reader.result.split(",")[1];
            resolve(base64Data);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

/* ============================================
   VALIDATION
============================================ */
function validateInputs() {
    const fields = ["participantID", "age", "gender", "country", "sentence", "emotion"];
    for (let id of fields) {
        if (document.getElementById(id).value.trim() === "") {
            alert("Please fill in all fields before recording.");
            return false;
        }
    }
    return true;
}

/* ============================================
   SEND TO SERVER (Apps Script)
============================================ */
async function sendToServer(blob, metadata) {
    const statusDiv = document.getElementById("status");
    try {
        statusDiv.textContent = "Uploading audio and metadata...";
        const audioBase64 = await blobToBase64(blob);

        const payload = {
            ...metadata,
            audioBase64: audioBase64,
            ip_address: clientIP
        };

        await fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        statusDiv.textContent = "‚úÖ Upload complete!";
        alert("Recording and metadata uploaded successfully!");


    } catch (err) {
        console.error(err);
        statusDiv.textContent = "‚ùå Upload failed.";
        alert("Upload failed: " + err);
    }
}

/* ============================================
   START RECORDING
============================================ */
document.getElementById("startBtn").onclick = async () => {

    if (!validateInputs()) return;

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstop = async () => {
            const blob = new Blob(audioChunks, { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);

            const audioPlayer = document.getElementById("audio");
            audioPlayer.src = url;
            audioPlayer.classList.remove("hidden");

            const pid = document.getElementById("participantID").value.trim();
            const age = document.getElementById("age").value.trim();
            const gender = document.getElementById("gender").value.trim();
            const country = document.getElementById("country").value.trim();
            const sentence = document.getElementById("sentence").value.trim();
            const emotion = document.getElementById("emotion").value.trim();

            const timestamp = new Date().toISOString();

            const cleanSentence = sentence.replace(/^\d+\.\s*/, "");
            const safe = cleanSentence
                .replace(/[\/\\:*?"<>|]/g, "")
                .replace(/\s+/g, "-");
            
            const safeIP = clientIP.replace(/\./g, "_");
            
            const filename = `${pid}-${safeIP}-${age}-${gender}-${country}-${emotion}-${safe}.wav`;

            const metadata = {
                participant_id: pid,
                age: age,
                gender: gender,
                country: country,
                emotion: emotion,
                sentence: sentence,
                filename: filename,
                timestamp: timestamp
            };

            await sendToServer(blob, metadata);
        };

        // UPDATE UI
        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;
        document.getElementById("startBtn").classList.add("bg-gray-400");
        document.getElementById("stopBtn").classList.add("bg-indigo-500");

    } catch (err) {
        alert("Mic permission error: " + err);
        console.error(err);
    }
};

/* ============================================
   STOP RECORDING
============================================ */
document.getElementById("stopBtn").onclick = () => {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
    }

    document.getElementById("startBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;

    document.getElementById("startBtn").classList.remove("bg-gray-400");
    document.getElementById("startBtn").classList.add("bg-red-500");

    document.getElementById("stopBtn").classList.add("bg-gray-400", "cursor-not-allowed");
};
</script>

<!-- AGREEMENT MODAL -->
<div id="agreementModal"
     class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full">

        <h2 class="text-xl font-bold mb-3">Participant Consent Agreement</h2>

        <p class="text-sm text-gray-700 mb-3">
            By participating in this research, you agree to the following:
        </p>

        <ul class="list-disc ml-5 text-sm text-gray-700 space-y-2">
            <li>Your voice recording, age, gender, country, emotion label, and IP address will be collected.</li>
            <li>Data will be used only for academic and research purposes (Speech Emotion Recognition).</li>
            <li>Your identity will not be revealed or used for commercial purposes.</li>
            <li>You may stop participation at any time by closing this page.</li>
        </ul>

        <p class="text-sm text-gray-700 mt-3">
            If you do not agree, please do not proceed with the recording.
        </p>

        <!-- CLOSE BUTTON -->
        <div class="text-right mt-6">
            <button id="closeModalBtn"
                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow">
                Close
            </button>
        </div>
    </div>
</div>

  
</body>
</html>
