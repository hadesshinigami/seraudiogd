<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emotion Voice Recorder</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-lg">

    <h2 class="text-3xl font-bold text-center mb-6 text-indigo-600">
        ğŸ¤ Emotion Voice Recorder
    </h2>

    <!-- PARTICIPANT ID -->
    <label class="font-semibold text-gray-700">Participant ID:</label>
    <input id="participantID" type="text"
           class="w-full p-3 rounded-lg border border-gray-300 mt-1 mb-4"
           placeholder="Enter your participant ID">

    <!-- AGE -->
    <label class="font-semibold text-gray-700">Age:</label>
    <input id="age" type="number" min="1"
           class="w-full p-3 rounded-lg border border-gray-300 mt-1 mb-4"
           placeholder="example: 25">

    <!-- GENDER -->
    <label class="font-semibold text-gray-700">Gender:</label>
    <select id="gender"
            class="w-full p-3 rounded-lg border border-gray-300 mt-1 mb-4">
        <option value="">-- Select Gender --</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
    </select>

    <!-- COUNTRY -->
    <label class="font-semibold text-gray-700">Country:</label>
    <select id="country"
            class="w-full p-3 rounded-lg border border-gray-300 mt-1 mb-4">
        <option value="">-- Select Country --</option>
        <option value="Japan">Japan</option>
        <option value="Indonesia">Indonesia</option>
        <option value="Other">Other</option>
    </select>

    <!-- SENTENCE -->
    <label class="font-semibold text-gray-700">Sentence to Speak:</label>
    <select id="sentence"
            class="w-full p-3 rounded-lg border border-gray-300 mt-1 mb-4">
        <option value="">-- Select Sentence --</option>

        <!-- INDONESIAN -->
        <option value="Hari ini hari sabtu.">1. Hari ini hari sabtu.</option>
        <option value="Saya sedang berbelanja.">2. Saya sedang berbelanja.</option>
        <option value="Saya berada di perpustakaan.">3. Saya berada di perpustakaan.</option>
        <option value="Di luar sedang turun hujan.">4. Di luar sedang turun hujan.</option>
        <option value="Saya sedang duduk di dalam ruangan.">5. Saya sedang duduk di dalam ruangan.</option>

        <!-- JAPANESE -->
        <option value="ä»Šæ—¥ã¯åœŸæ›œæ—¥ã§ã™ã€‚">1. ä»Šæ—¥ã¯åœŸæ›œæ—¥ã§ã™ã€‚</option>
        <option value="ç§ã¯è²·ã„ç‰©ã‚’ã—ã¦ã„ã¾ã™ã€‚">2. ç§ã¯è²·ã„ç‰©ã‚’ã—ã¦ã„ã¾ã™ã€‚</option>
        <option value="ç§ã¯å›³æ›¸é¤¨ã«ã„ã¾ã™ã€‚">3. ç§ã¯å›³æ›¸é¤¨ã«ã„ã¾ã™ã€‚</option>
        <option value="å¤–ã¯é›¨ãŒé™ã£ã¦ã„ã¾ã™ã€‚">4. å¤–ã¯é›¨ãŒé™ã£ã¦ã„ã¾ã™ã€‚</option>
        <option value="ç§ã¯éƒ¨å±‹ã«åº§ã£ã¦ã„ã¾ã™ã€‚">5. ç§ã¯éƒ¨å±‹ã«åº§ã£ã¦ã„ã¾ã™ã€‚</option>
    </select>

    <!-- EMOTION -->
    <label class="font-semibold text-gray-700">Select Emotion:</label>
    <select id="emotion"
            class="w-full p-3 rounded-lg border mt-1 mb-6 border-gray-300">
        <option value="">-- Select Emotion --</option>
        <option value="happy">Happy</option>
        <option value="angry">Angry</option>
        <option value="sad">Sad</option>
        <option value="relaxed">Relaxed</option>
    </select>

    <!-- BUTTONS -->
    <div class="flex justify-center space-x-6 mb-6">
        <button id="startBtn"
                class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-full text-xl shadow-md transition">
            ğŸ”´ Record
        </button>

        <button id="stopBtn"
                class="bg-gray-400 text-white px-6 py-3 rounded-full text-xl shadow-md cursor-not-allowed"
                disabled>
            â¹ Stop
        </button>
    </div>

    <!-- AUDIO PREVIEW -->
    <audio id="audio" controls class="w-full mb-4 hidden"></audio>

    <!-- DOWNLOAD CSV -->
    <button id="downloadCSV"
            class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg shadow-md mb-4">
        ğŸ“„ Download Full CSV Dataset
    </button>

    <!-- RESET CSV -->
    <button id="resetCSV"
            class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg shadow-md">
        âŒ Reset Metadata
    </button>

</div>


<script>
/* ===========================================================
   GLOBAL VARIABLES
=========================================================== */
let mediaRecorder;
let audioChunks = [];
let metadataRows = JSON.parse(localStorage.getItem("metadataSER")) || [];
let userIP = "unknown";

/* ===========================================================
   FETCH USER IP
=========================================================== */
fetch("https://api.ipify.org?format=json")
    .then(r => r.json())
    .then(d => userIP = d.ip)
    .catch(() => userIP = "unknown");


/* ===========================================================
   UPLOAD TO GOOGLE DRIVE
=========================================================== */
async function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

async function uploadToDrive(blob, filename, metadataObj) {
    const base64File = await blobToBase64(blob);

    const payload = {
        fileData: base64File,
        filename: filename,
        metadata: metadataObj
    };

    const response = await fetch("PASTE_WEB_APP_URL", {
        method: "POST",
        body: JSON.stringify(payload),
        headers: {
            "Content-Type": "application/json"
        }
    });

    const result = await response.json();
    console.log(result);
}



/* ===========================================================
   LOCAL STORAGE SAVE
=========================================================== */
function saveMetadataToLocalStorage() {
    localStorage.setItem("metadataSER", JSON.stringify(metadataRows));
}


/* ===========================================================
   VALIDATION
=========================================================== */
function validateInputs() {
    const fields = ["participantID", "age", "gender", "country", "sentence", "emotion"];
    for (let id of fields) {
        if (document.getElementById(id).value.trim() === "") {
            alert("Please fill in all fields before recording.");
            return false;
        }
    }
    return true;
}


/* ===========================================================
   START RECORDING
=========================================================== */
document.getElementById("startBtn").onclick = async () => {

    if (!validateInputs()) return;

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.start();
    audioChunks = [];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = async () => {

        /* CREATE WAV BLOB */
        const blob = new Blob(audioChunks, { type: 'audio/wav' });
        const url = URL.createObjectURL(blob);

        const audioPlayer = document.getElementById("audio");
        audioPlayer.src = url;
        audioPlayer.classList.remove("hidden");

        /* COLLECT METADATA */
        const pid = document.getElementById("participantID").value.trim();
        const ageVal = document.getElementById("age").value.trim();
        const genderVal = document.getElementById("gender").value.trim();
        const countryVal = document.getElementById("country").value.trim();
        const sentenceVal = document.getElementById("sentence").value.trim();
        const emotionVal = document.getElementById("emotion").value.trim();

        const age = ageVal;
        const gender = genderVal;
        const country = countryVal;
        const sentence = sentenceVal;
        const emotion = emotionVal;


        const timestamp = new Date().toISOString();

        /* CLEAN FILENAME */
        const cleanSentence = sentence.replace(/^\d+\.\s*/, "");
        const safe = cleanSentence.replace(/[\/\\:*?"<>|]/g, "").replace(/\s+/g, "-");

        const filename = `${pid}-${age}-${gender}-${country}-${emotion}-${safe}.wav`;

        /* AUTO DOWNLOAD WAV */
        const wavLink = document.createElement("a");
        wavLink.href = url;
        wavLink.download = filename;
        document.body.appendChild(wavLink);
        wavLink.click();
        document.body.removeChild(wavLink);

        /* METADATA OBJECT */
        const metadata = {
            participant_id: pid,
            age: age,
            gender: gender,
            country: country,
            emotion: emotion,
            sentence: sentence,
            filename: filename,
            timestamp: timestamp,
            ip: userIP
        };

        /* SAVE LOCAL */
        metadataRows.push(metadata);
        saveMetadataToLocalStorage();

        /* UPLOAD TO GOOGLE DRIVE */
        await uploadToDrive(blob, filename, metadata);

        alert("Recording saved and uploaded to Google Drive!");
    };

    /* UPDATE UI */
    startBtn.disabled = true;
    stopBtn.disabled = false;
    startBtn.classList.add("bg-gray-400");
    stopBtn.classList.add("bg-indigo-500");
};


/* ===========================================================
   STOP RECORDING
=========================================================== */
document.getElementById("stopBtn").onclick = () => {
    mediaRecorder.stop();

    startBtn.disabled = false;
    stopBtn.disabled = true;

    startBtn.classList.remove("bg-gray-400");
    startBtn.classList.add("bg-red-500");

    stopBtn.classList.add("bg-gray-400", "cursor-not-allowed");
};


/* ===========================================================
   DOWNLOAD CSV
=========================================================== */
document.getElementById("downloadCSV").onclick = () => {

    if (metadataRows.length === 0) {
        alert("No recordings saved yet.");
        return;
    }

    let csv = "participant_id,age,gender,country,emotion,sentence,filename,timestamp,ip\n";

    metadataRows.forEach(row => {
        csv += `${row.participant_id},${row.age},${row.gender},${row.country},${row.emotion},"${row.sentence}",${row.filename},${row.timestamp},${row.ip}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "SER_metadata_full.csv";
    a.click();
};


/* ===========================================================
   RESET METADATA
=========================================================== */
document.getElementById("resetCSV").onclick = () => {

    if (!confirm("Are you sure you want to delete all metadata?")) return;

    metadataRows = [];
    saveMetadataToLocalStorage();

    alert("All metadata cleared!");
};

</script>

</body>
</html>







